{
  "version": 3,
  "sources": ["../../lib/net.ts"],
  "sourcesContent": ["/**\r\n * Net - abstraction layer around Node's HTTP/S request system.\r\n * Advantages:\r\n * - easier acquiring of data\r\n * - mass disabling of outgoing requests via Config.\r\n */\r\n\r\nimport * as https from 'https';\r\nimport * as http from 'http';\r\nimport * as url from 'url';\r\nimport * as Streams from './streams';\r\ndeclare const Config: any;\r\n\r\nexport interface PostData {\r\n\t[key: string]: string | number;\r\n}\r\nexport interface NetRequestOptions extends https.RequestOptions {\r\n\tbody?: string | PostData;\r\n\twritable?: boolean;\r\n\tquery?: PostData;\r\n}\r\n\r\nexport class HttpError extends Error {\r\n\tstatusCode?: number;\r\n\tbody: string;\r\n\tconstructor(message: string, statusCode: number | undefined, body: string) {\r\n\t\tsuper(message);\r\n\t\tthis.name = 'HttpError';\r\n\t\tthis.statusCode = statusCode;\r\n\t\tthis.body = body;\r\n\t\tError.captureStackTrace(this, HttpError);\r\n\t}\r\n}\r\n\r\nexport class NetStream extends Streams.ReadWriteStream {\r\n\topts: NetRequestOptions | null;\r\n\turi: string;\r\n\trequest: http.ClientRequest;\r\n\t/** will be a Promise before the response is received, and the response itself after */\r\n\tresponse: Promise<http.IncomingMessage | null> | http.IncomingMessage | null;\r\n\tstatusCode: number | null;\r\n\t/** response headers */\r\n\theaders: http.IncomingHttpHeaders | null;\r\n\tstate: 'pending' | 'open' | 'timeout' | 'success' | 'error';\r\n\r\n\tconstructor(uri: string, opts: NetRequestOptions | null = null) {\r\n\t\tsuper();\r\n\t\tthis.statusCode = null;\r\n\t\tthis.headers = null;\r\n\t\tthis.uri = uri;\r\n\t\tthis.opts = opts;\r\n\t\t// make request\r\n\t\tthis.response = null;\r\n\t\tthis.state = 'pending';\r\n\t\tthis.request = this.makeRequest(opts);\r\n\t}\r\n\tmakeRequest(opts: NetRequestOptions | null) {\r\n\t\tif (!opts) opts = {};\r\n\t\tlet body = opts.body;\r\n\t\tif (body && typeof body !== 'string') {\r\n\t\t\tif (!opts.headers) opts.headers = {};\r\n\t\t\tif (!opts.headers['Content-Type']) {\r\n\t\t\t\topts.headers['Content-Type'] = 'application/x-www-form-urlencoded';\r\n\t\t\t}\r\n\t\t\tbody = NetStream.encodeQuery(body);\r\n\t\t}\r\n\r\n\t\tif (opts.query) {\r\n\t\t\tthis.uri += (this.uri.includes('?') ? '&' : '?') + NetStream.encodeQuery(opts.query);\r\n\t\t}\r\n\r\n\t\tif (body) {\r\n\t\t\tif (!opts.headers) opts.headers = {};\r\n\t\t\tif (!opts.headers['Content-Length']) {\r\n\t\t\t\topts.headers['Content-Length'] = Buffer.byteLength(body);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst protocol = url.parse(this.uri).protocol as string;\r\n\t\tconst net = protocol === 'https:' ? https : http;\r\n\r\n\t\tlet resolveResponse: ((value: http.IncomingMessage | null) => void) | null;\r\n\t\tthis.response = new Promise(resolve => {\r\n\t\t\tresolveResponse = resolve;\r\n\t\t});\r\n\r\n\t\tconst request = net.request(this.uri, opts, response => {\r\n\t\t\tthis.state = 'open';\r\n\t\t\tthis.nodeReadableStream = response;\r\n\t\t\tthis.response = response;\r\n\t\t\tthis.statusCode = response.statusCode || null;\r\n\t\t\tthis.headers = response.headers;\r\n\r\n\t\t\tresponse.setEncoding('utf-8');\r\n\t\t\tresolveResponse!(response);\r\n\t\t\tresolveResponse = null;\r\n\r\n\t\t\tresponse.on('data', data => {\r\n\t\t\t\tthis.push(data);\r\n\t\t\t});\r\n\t\t\tresponse.on('end', () => {\r\n\t\t\t\tif (this.state === 'open') this.state = 'success';\r\n\t\t\t\tif (!this.atEOF) this.pushEnd();\r\n\t\t\t});\r\n\t\t});\r\n\t\trequest.on('close', () => {\r\n\t\t\tif (!this.atEOF) {\r\n\t\t\t\tthis.state = 'error';\r\n\t\t\t\tthis.pushError(new Error(\"Unexpected connection close\"));\r\n\t\t\t}\r\n\t\t\tif (resolveResponse) {\r\n\t\t\t\tthis.response = null;\r\n\t\t\t\tresolveResponse(null);\r\n\t\t\t\tresolveResponse = null;\r\n\t\t\t}\r\n\t\t});\r\n\t\trequest.on('error', error => {\r\n\t\t\tif (!this.atEOF) this.pushError(error, true);\r\n\t\t});\r\n\t\tif (opts.timeout || opts.timeout === undefined) {\r\n\t\t\trequest.setTimeout(opts.timeout || 5000, () => {\r\n\t\t\t\tthis.state = 'timeout';\r\n\t\t\t\tthis.pushError(new Error(\"Request timeout\"));\r\n\t\t\t\trequest.abort();\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (body) {\r\n\t\t\trequest.write(body);\r\n\t\t\trequest.end();\r\n\t\t\tif (opts.writable) {\r\n\t\t\t\tthrow new Error(`options.body is what you would have written to a NetStream - you must choose one or the other`);\r\n\t\t\t}\r\n\t\t} else if (opts.writable) {\r\n\t\t\tthis.nodeWritableStream = request;\r\n\t\t} else {\r\n\t\t\trequest.end();\r\n\t\t}\r\n\r\n\t\treturn request;\r\n\t}\r\n\tstatic encodeQuery(data: PostData) {\r\n\t\tlet out = '';\r\n\t\tfor (const key in data) {\r\n\t\t\tif (out) out += `&`;\r\n\t\t\tout += `${key}=${encodeURIComponent('' + data[key])}`;\r\n\t\t}\r\n\t\treturn out;\r\n\t}\r\n\t_write(data: string | Buffer): Promise<void> | void {\r\n\t\tif (!this.nodeWritableStream) {\r\n\t\t\tthrow new Error(\"You must specify opts.writable to write to a request.\");\r\n\t\t}\r\n\t\tconst result = this.nodeWritableStream.write(data);\r\n\t\tif (result !== false) return undefined;\r\n\t\tif (!this.drainListeners.length) {\r\n\t\t\tthis.nodeWritableStream.once('drain', () => {\r\n\t\t\t\tfor (const listener of this.drainListeners) listener();\r\n\t\t\t\tthis.drainListeners = [];\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.drainListeners.push(resolve);\r\n\t\t});\r\n\t}\r\n\t_read() {\r\n\t\tthis.nodeReadableStream?.resume();\r\n\t}\r\n\t_pause() {\r\n\t\tthis.nodeReadableStream?.pause();\r\n\t}\r\n}\r\nexport class NetRequest {\r\n\turi: string;\r\n\tconstructor(uri: string) {\r\n\t\tthis.uri = uri;\r\n\t}\r\n\t/**\r\n\t * Makes a http/https get request to the given link and returns a stream.\r\n\t * The request data itself can be read with ReadStream#readAll().\r\n\t * The NetStream class also holds headers and statusCode as a property.\r\n\t *\r\n\t * @param opts request opts - headers, etc.\r\n\t * @param body POST body\r\n\t */\r\n\tgetStream(opts: NetRequestOptions = {}) {\r\n\t\tif (typeof Config !== 'undefined' && Config.noNetRequests) {\r\n\t\t\tthrow new Error(`Net requests are disabled.`);\r\n\t\t}\r\n\t\tconst stream = new NetStream(this.uri, opts);\r\n\t\treturn stream;\r\n\t}\r\n\r\n\t/**\r\n\t * Makes a basic http/https request to the URI.\r\n\t * Returns the response data.\r\n\t *\r\n\t * Will throw if the response code isn't 200 OK.\r\n\t *\r\n\t * @param opts request opts - headers, etc.\r\n\t */\r\n\tasync get(opts: NetRequestOptions = {}): Promise<string> {\r\n\t\tconst stream = this.getStream(opts);\r\n\t\tconst response = await stream.response;\r\n\t\tif (response && response.statusCode !== 200) {\r\n\t\t\tthrow new HttpError(response.statusMessage || \"Connection error\", response.statusCode, await stream.readAll());\r\n\t\t}\r\n\t\treturn stream.readAll();\r\n\t}\r\n\r\n\t/**\r\n\t * Makes a http/https POST request to the given link.\r\n\t * @param opts request opts - headers, etc.\r\n\t * @param body POST body\r\n\t */\r\n\tpost(opts: Omit<NetRequestOptions, 'body'>, body: PostData | string): Promise<string>;\r\n\t/**\r\n\t * Makes a http/https POST request to the given link.\r\n\t * @param opts request opts - headers, etc.\r\n\t */\r\n\tpost(opts?: NetRequestOptions): Promise<string>;\r\n\tpost(opts: NetRequestOptions = {}, body?: PostData | string) {\r\n\t\tif (!body) body = opts.body;\r\n\t\treturn this.get({\r\n\t\t\t...opts,\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport const Net = Object.assign((path: string) => new NetRequest(path), {\r\n\tNetRequest, NetStream,\r\n});\r\n"],
  "mappings": "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",
  "names": []
}
