{
  "version": 3,
  "sources": ["../../../server/chat-plugins/stickers.ts"],
  "sourcesContent": ["/* eslint max-len: [\"error\", 240] */\r\n\r\nimport {FS} from '../../lib';\r\nimport {Punishments} from '../punishments';\r\nimport {downloadImageWithVerification} from '../../lib/image';\r\nimport {checkEmojiLevel} from './emojis';\r\n\r\nconst MAX_STICKER_SIZE = 160;\r\nconst STICKER_SIZE = 64;\r\nconst ERROR_NO_STICKER_NAME = 'Specify an sticker name.';\r\nconst ERROR_NO_STICKER_URL = 'Specify an sticker URL.';\r\nconst COOLDOWN = 10 * 1000;\r\n\r\nexport interface Sticker {\r\n\tfilename: string;\r\n\twidth: number;\r\n\theight: number;\r\n}\r\n\r\ntype Stickers = Record<string, Sticker>;\r\n\r\nexport const stickers: Stickers = JSON.parse(\r\n\tFS('config/chat-plugins/stickers.json').readIfExistsSync() || \"{}\"\r\n);\r\n\r\nconst saveStickers = () => {\r\n\tFS('config/chat-plugins/stickers.json').writeUpdate(() => JSON.stringify(stickers));\r\n};\r\n\r\nconst addOrUpdateSticker = (name: string, sticker: Sticker) => {\r\n\tstickers[name] = sticker;\r\n\tsaveStickers();\r\n};\r\n\r\nconst deleteSticker = (name: string) => {\r\n\tdelete stickers[name];\r\n\tsaveStickers();\r\n};\r\n\r\nconst cooldowns: Record<string, number> = {};\r\n\r\nconst checkCooldown = (userID: ID) => {\r\n\tconst now = Date.now();\r\n\tconst activeCooldown = cooldowns[userID];\r\n\r\n\tif (activeCooldown && ((now - activeCooldown) < COOLDOWN)) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\tcooldowns[userID] = now;\r\n\treturn true;\r\n};\r\n\r\nconst toAlphaNumeric = (text: string) => ('' + text).replace(/[^A-Za-z0-9]+/g, '');\r\n\r\nexport const createStickerHtml = (\r\n\tname: string,\r\n\tsticker: Sticker,\r\n\tpath = ''\r\n) => `<img src=\"https://clover.weedl.es:8443/stickers/${path}${sticker.filename}\" title=\"/gif ${name}\" height=\"${sticker.height}\" width=\"${sticker.width}\">`;\r\n\r\nexport const downloadSticker = async (stickerName: string, imageUrl: string, path = './config/stickers'): Promise<Sticker> => {\r\n\tconst result = await downloadImageWithVerification(imageUrl, {\r\n\t\tvalidTypes: ['png', 'gif'],\r\n\t\tenforceRatio: {min: {width: 1, height: 2}, max: {width: 2, height: 1}},\r\n\t\tminDimensions: {width: STICKER_SIZE, height: STICKER_SIZE},\r\n\t\tmaxDimensions: {width: MAX_STICKER_SIZE, height: MAX_STICKER_SIZE},\r\n\t\tfileSize: 1000000,\r\n\t});\r\n\r\n\tif ('error' in result) {\r\n\t\tthrow new Chat.ErrorMessage(result.error);\r\n\t}\r\n\r\n\tconst fileName = `${stickerName}.${result.type}`;\r\n\tawait FS(`${path}/${fileName}`).write(result.image);\r\n\r\n\treturn {filename: fileName, width: result.width, height: result.height};\r\n};\r\n\r\nexport const commands: Chat.ChatCommands = {\r\n\tgif: 'sticker',\r\n\tsticker(target, room, user) {\r\n\t\tif (Punishments.hasPunishType(user.id, 'EMOJIBAN')) {\r\n\t\t\tthrow new Chat.ErrorMessage('You are banned from using stickers.');\r\n\t\t}\r\n\r\n\t\tif (room && !checkEmojiLevel(user, room)) {\r\n\t\t\tthrow new Chat.ErrorMessage('You cannot use stickers in this room.');\r\n\t\t}\r\n\r\n\t\tthis.checkChat();\r\n\r\n\t\tconst stickerName = target.trim();\r\n\t\tconst sticker = stickers[stickerName];\r\n\r\n\t\tif (!sticker) throw new Chat.ErrorMessage(`No such sticker ${stickerName} exists.`);\r\n\r\n\t\tif (!checkCooldown(user.id)) {\r\n\t\t\tthrow new Chat.ErrorMessage('You are using stickers too quickly.');\r\n\t\t}\r\n\r\n\t\treturn `/html ${createStickerHtml(stickerName, sticker)}`;\r\n\t},\r\n\tmanagegif: 'managesticker',\r\n\tmanagesticker: {\r\n\t\tlist() {\r\n\t\t\tthis.runBroadcast();\r\n\t\t\treturn this.sendReplyBox(`<b><u>Stickers</u> <i>(hover for name, try <code>/gif STICKERNAME</code>)</i></b><br />${Object.entries(stickers).map(([stickerName, stickerUrl]) => createStickerHtml(stickerName, stickerUrl)).join(' ')}`);\r\n\t\t},\r\n\t\tupdate: 'add',\r\n\t\tasync add(target, room, user) {\r\n\t\t\tthis.checkCan('emoji');\r\n\t\t\tconst [rawStickerName, stickerUrl] = target.split(',').map((part) => part.trim());\r\n\r\n\t\t\tif (!rawStickerName) {\r\n\t\t\t\treturn this.errorReply(ERROR_NO_STICKER_NAME);\r\n\t\t\t}\r\n\t\t\tconst stickerName = toAlphaNumeric(rawStickerName);\r\n\r\n\t\t\tif (!stickerUrl) {\r\n\t\t\t\treturn this.errorReply(ERROR_NO_STICKER_URL);\r\n\t\t\t}\r\n\r\n\t\t\tconst sticker = await downloadSticker(stickerName, stickerUrl);\r\n\r\n\t\t\taddOrUpdateSticker(stickerName, sticker);\r\n\r\n\t\t\tthis.addGlobalModAction(`${user.name} added sticker ${stickerName}`);\r\n\t\t\treturn this.sendReplyBox(`Added: ${createStickerHtml(stickerName, sticker)}`);\r\n\t\t},\r\n\t\tremove(target, room, user) {\r\n\t\t\tthis.checkCan('emoji');\r\n\t\t\tconst stickerName = toAlphaNumeric(target);\r\n\r\n\t\t\tif (!stickers[stickerName]) {\r\n\t\t\t\treturn this.sendReplyBox(`No such sticker ${stickerName} exists.`);\r\n\t\t\t}\r\n\r\n\t\t\tdeleteSticker(stickerName);\r\n\r\n\t\t\tthis.addGlobalModAction(`${user.name} deleted sticker ${stickerName}`);\r\n\t\t\treturn this.sendReply(`Deleted ${stickerName}`);\r\n\t\t},\r\n\t},\r\n\tmanagestickerhelp() {\r\n\t\tthis.runBroadcast();\r\n\t\treturn this.sendReplyBox([\r\n\t\t\t`<code>/managesticker list</code> - Lists all available stickers.`,\r\n\t\t\t`<code>/managesticker add [name], [image url]</code> - Adds or updates an sticker. Requires: &`,\r\n\t\t\t`<code>/maangesticker remove [name]</code> - Removes an sticker. Requires: &`,\r\n\t\t].join('<br />'));\r\n\t},\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
