{
  "version": 3,
  "sources": ["../../../server/chat-plugins/watch-format.ts"],
  "sourcesContent": ["import {FS} from '../../lib';\r\n\r\ntype RoomBattleReporterConfig = Record<string, { rooms: Record<string, boolean> }>;\r\n\r\nconst roomBattleReporterConfig: RoomBattleReporterConfig = JSON.parse(\r\n\tFS('config/chat-plugins/room-battles.json').readIfExistsSync() || \"{}\"\r\n);\r\n\r\nconst saveRoomBattleReporterConfig = () => {\r\n\tFS('config/chat-plugins/room-battles.json').writeUpdate(() => JSON.stringify(roomBattleReporterConfig));\r\n};\r\n\r\nconst addRoom = (formatId: string, roomId: string) => {\r\n\tconst rooms = roomBattleReporterConfig[formatId] || {rooms: {}};\r\n\r\n\trooms.rooms[roomId] = true;\r\n\r\n\troomBattleReporterConfig[formatId] = rooms;\r\n\r\n\tsaveRoomBattleReporterConfig();\r\n};\r\n\r\nconst removeRoom = (formatId: string, roomId: string) => {\r\n\tconst rooms = roomBattleReporterConfig[formatId] || {rooms: {}};\r\n\r\n\tdelete rooms.rooms[roomId];\r\n\r\n\troomBattleReporterConfig[formatId] = rooms;\r\n\r\n\tsaveRoomBattleReporterConfig();\r\n};\r\n\r\nconst getRooms = (formatId: string) => {\r\n\tconst rooms = roomBattleReporterConfig[formatId];\r\n\r\n\tif (rooms) {\r\n\t\treturn Object.keys(rooms.rooms)\r\n\t\t\t.map((roomId) => Rooms.get(roomId))\r\n\t\t\t.filter((room) => room !== undefined) as Room[];\r\n\t}\r\n\r\n\treturn [];\r\n};\r\n\r\nexport const commands: Chat.ChatCommands = {\r\n\twatchformat(target, room) {\r\n\t\tif (!room) {\r\n\t\t\tthrow new Chat.ErrorMessage(`Command must be used from a room.`);\r\n\t\t}\r\n\r\n\t\tthis.checkCan('editroom', null, room);\r\n\r\n\t\tconst format = Dex.formats.get(target);\r\n\r\n\t\tif (!format.exists) {\r\n\t\t\tthrow new Chat.ErrorMessage(`Format ${format} doesn't exist.`);\r\n\t\t}\r\n\r\n\t\taddRoom(format.id, room.roomid);\r\n\r\n\t\treturn this.sendReply(`Successfully added ${format.name} to watched formats.`);\r\n\t},\r\n\tunwatchformat(target, room) {\r\n\t\tif (!room) {\r\n\t\t\tthrow new Chat.ErrorMessage(`Command must be used from a room.`);\r\n\t\t}\r\n\r\n\t\tthis.checkCan('editroom', null, room);\r\n\r\n\t\tconst format = Dex.formats.get(target);\r\n\r\n\t\tif (!format) {\r\n\t\t\tthrow new Chat.ErrorMessage(`Format ${format} doesn't exist.`);\r\n\t\t}\r\n\r\n\t\tremoveRoom(format.id, room.roomid);\r\n\r\n\t\treturn this.sendReply(`Successfully removed ${format.name} to watched formats.`);\r\n\t},\r\n\tunwatchformathelp: 'watchformathelp',\r\n\twatchformathelp() {\r\n\t\tthis.sendReplyBox(\r\n\t\t\t'<code>/watchformat [format]</code>: adds a format to report battles on in the current room. Requires: #, &<br />' +\r\n\t\t\t'<code>/unwatchformat [format]</code>: removes a format to report battles on in the current room. Requires: #, &',\r\n\t\t);\r\n\t},\r\n};\r\n\r\nconst handledBattles: Record<string, boolean> = {};\r\n\r\nexport const handlers: Chat.Handlers = {\r\n\tonBattleStart(user, room) {\r\n\t\tconst players = [room.p1, room.p2, room.p3, room.p4]\r\n\t\t\t.filter((player) => player !== null) as User[];\r\n\t\tconst reportPlayers = players.map(p => p.getIdentity()).join('|');\r\n\r\n\t\tconst battleRoomId = toID(room.format);\r\n\r\n\t\tif (handledBattles[battleRoomId]) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst formatRooms = getRooms(battleRoomId);\r\n\t\tformatRooms.forEach((formatRoom) => {\r\n\t\t\tformatRoom\r\n\t\t\t\t.add(`|b|${room.roomid}|${reportPlayers}`)\r\n\t\t\t\t.update();\r\n\t\t});\r\n\r\n\t\thandledBattles[battleRoomId] = true;\r\n\t},\r\n\tonBattleEnd(battle) {\r\n\t\tdelete handledBattles[battle.roomid];\r\n\t},\r\n};\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBAAiB;AAIjB,MAAM,2BAAqD,KAAK;AAAA,MAC/D,eAAG,uCAAuC,EAAE,iBAAiB,KAAK;AACnE;AAEA,MAAM,+BAA+B,MAAM;AAC1C,qBAAG,uCAAuC,EAAE,YAAY,MAAM,KAAK,UAAU,wBAAwB,CAAC;AACvG;AAEA,MAAM,UAAU,CAAC,UAAkB,WAAmB;AACrD,QAAM,QAAQ,yBAAyB,QAAQ,KAAK,EAAC,OAAO,CAAC,EAAC;AAE9D,QAAM,MAAM,MAAM,IAAI;AAEtB,2BAAyB,QAAQ,IAAI;AAErC,+BAA6B;AAC9B;AAEA,MAAM,aAAa,CAAC,UAAkB,WAAmB;AACxD,QAAM,QAAQ,yBAAyB,QAAQ,KAAK,EAAC,OAAO,CAAC,EAAC;AAE9D,SAAO,MAAM,MAAM,MAAM;AAEzB,2BAAyB,QAAQ,IAAI;AAErC,+BAA6B;AAC9B;AAEA,MAAM,WAAW,CAAC,aAAqB;AACtC,QAAM,QAAQ,yBAAyB,QAAQ;AAE/C,MAAI,OAAO;AACV,WAAO,OAAO,KAAK,MAAM,KAAK,EAC5B,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM,CAAC,EACjC,OAAO,CAAC,SAAS,SAAS,MAAS;AAAA,EACtC;AAEA,SAAO,CAAC;AACT;AAEO,MAAM,WAA8B;AAAA,EAC1C,YAAY,QAAQ,MAAM;AACzB,QAAI,CAAC,MAAM;AACV,YAAM,IAAI,KAAK,aAAa,mCAAmC;AAAA,IAChE;AAEA,SAAK,SAAS,YAAY,MAAM,IAAI;AAEpC,UAAM,SAAS,IAAI,QAAQ,IAAI,MAAM;AAErC,QAAI,CAAC,OAAO,QAAQ;AACnB,YAAM,IAAI,KAAK,aAAa,UAAU,uBAAuB;AAAA,IAC9D;AAEA,YAAQ,OAAO,IAAI,KAAK,MAAM;AAE9B,WAAO,KAAK,UAAU,sBAAsB,OAAO,0BAA0B;AAAA,EAC9E;AAAA,EACA,cAAc,QAAQ,MAAM;AAC3B,QAAI,CAAC,MAAM;AACV,YAAM,IAAI,KAAK,aAAa,mCAAmC;AAAA,IAChE;AAEA,SAAK,SAAS,YAAY,MAAM,IAAI;AAEpC,UAAM,SAAS,IAAI,QAAQ,IAAI,MAAM;AAErC,QAAI,CAAC,QAAQ;AACZ,YAAM,IAAI,KAAK,aAAa,UAAU,uBAAuB;AAAA,IAC9D;AAEA,eAAW,OAAO,IAAI,KAAK,MAAM;AAEjC,WAAO,KAAK,UAAU,wBAAwB,OAAO,0BAA0B;AAAA,EAChF;AAAA,EACA,mBAAmB;AAAA,EACnB,kBAAkB;AACjB,SAAK;AAAA,MACJ;AAAA,IAED;AAAA,EACD;AACD;AAEA,MAAM,iBAA0C,CAAC;AAE1C,MAAM,WAA0B;AAAA,EACtC,cAAc,MAAM,MAAM;AACzB,UAAM,UAAU,CAAC,KAAK,IAAI,KAAK,IAAI,KAAK,IAAI,KAAK,EAAE,EACjD,OAAO,CAAC,WAAW,WAAW,IAAI;AACpC,UAAM,gBAAgB,QAAQ,IAAI,OAAK,EAAE,YAAY,CAAC,EAAE,KAAK,GAAG;AAEhE,UAAM,eAAe,KAAK,KAAK,MAAM;AAErC,QAAI,eAAe,YAAY,GAAG;AACjC;AAAA,IACD;AAEA,UAAM,cAAc,SAAS,YAAY;AACzC,gBAAY,QAAQ,CAAC,eAAe;AACnC,iBACE,IAAI,MAAM,KAAK,UAAU,eAAe,EACxC,OAAO;AAAA,IACV,CAAC;AAED,mBAAe,YAAY,IAAI;AAAA,EAChC;AAAA,EACA,YAAY,QAAQ;AACnB,WAAO,eAAe,OAAO,MAAM;AAAA,EACpC;AACD;",
  "names": []
}
